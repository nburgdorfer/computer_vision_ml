import sys
import numpy as np
from PIL import Image
from sklearn.neighbors import KDTree
import pprint

def main():

    if len(sys.argv) != 2:
        print("ERROR: Usage - pyhton3 {0} <error-colormap-image>".format(sys.argv[0]))
        sys.exit()

    # Need to test with Non-PNG files **should work**
    image = Image.open(sys.argv[1])
    img_pixels = image.load()
    width,height = image.size

    I = np.array([[0.00000,   0.00000,   0.00000],
    [0.00000,   0.00000,   0.03440],
    [0.00000,   0.00000,   0.06880],
    [0.00000,   0.00000,   0.10320],
    [0.00000,   0.00000,   0.13760],
    [0.00000,   0.00000,   0.17200],
    [0.00000,   0.00000,   0.20640],
    [0.00000,   0.00000,   0.24080],
    [0.00000,   0.00000,   0.27520],
    [0.00000,   0.00000,   0.30960],
    [0.00000,   0.00000,   0.34400],
    [0.00000,   0.00000,   0.37840],
    [0.00000,   0.00000,   0.41280],
    [0.00000,   0.00000,   0.44720],
    [0.00000,   0.00000,   0.48160],
    [0.00000,   0.00000,   0.51600],
    [0.00000,   0.00000,   0.55040],
    [0.00000,   0.00000,   0.58480],
    [0.00000,   0.00000,   0.61920],
    [0.00000,   0.00000,   0.65359],
    [0.00000,   0.00000,   0.68799],
    [0.00000,   0.00000,   0.72239],
    [0.00000,   0.00000,   0.75679],
    [0.00000,   0.00000,   0.79119],
    [0.00000,   0.00000,   0.82559],
    [0.00000,   0.00000,   0.85999],
    [0.00000,   0.00000,   0.89439],
    [0.00000,   0.00000,   0.92879],
    [0.00000,   0.00000,   0.96319],
    [0.00000,   0.00000,   0.99759],
    [0.01971,   0.00000,   0.98029],
    [0.04091,   0.00000,   0.95909],
    [0.06211,   0.00000,   0.93789],
    [0.08331,   0.00000,   0.91669],
    [0.10450,   0.00000,   0.89550],
    [0.12570,   0.00000,   0.87430],
    [0.14690,   0.00000,   0.85310],
    [0.16810,   0.00000,   0.83190],
    [0.18930,   0.00000,   0.81070],
    [0.21049,   0.00000,   0.78951],
    [0.23169,   0.00000,   0.76831],
    [0.25289,   0.00000,   0.74711],
    [0.27409,   0.00000,   0.72591],
    [0.29528,   0.00000,   0.70472],
    [0.31648,   0.00000,   0.68352],
    [0.33768,   0.00000,   0.66232],
    [0.35888,   0.00000,   0.64112],
    [0.38007,   0.00000,   0.61993],
    [0.40127,   0.00000,   0.59873],
    [0.42247,   0.00000,   0.57753],
    [0.44367,   0.00000,   0.55633],
    [0.46486,   0.00000,   0.53514],
    [0.48606,   0.00000,   0.51394],
    [0.50726,   0.00000,   0.49274],
    [0.52846,   0.00000,   0.47154],
    [0.54966,   0.00000,   0.45034],
    [0.57085,   0.00000,   0.42915],
    [0.59205,   0.00000,   0.40795],
    [0.61325,   0.00000,   0.38675],
    [0.63445,   0.00000,   0.36555],
    [0.65564,   0.00000,   0.34436],
    [0.67684,   0.00000,   0.32316],
    [0.69804,   0.00000,   0.30196],
    [0.71924,   0.00000,   0.28076],
    [0.74043,   0.00000,   0.25957],
    [0.76163,   0.00000,   0.23837],
    [0.78283,   0.00000,   0.21717],
    [0.80403,   0.00000,   0.19597],
    [0.82523,   0.00000,   0.17477],
    [0.84642,   0.00000,   0.15358],
    [0.86762,   0.00000,   0.13238],
    [0.88882,   0.00000,   0.11118],
    [0.91002,   0.00000,   0.08998],
    [0.93121,   0.00000,   0.06879],
    [0.95241,   0.00000,   0.04759],
    [0.97361,   0.00000,   0.02639],
    [0.99481,   0.00000,   0.00519],
    [1.00000,   0.00000,   0.02597],
    [1.00000,   0.00000,   0.06037],
    [1.00000,   0.00000,   0.09477],
    [1.00000,   0.00000,   0.12917],
    [1.00000,   0.00000,   0.16357],
    [1.00000,   0.00000,   0.19797],
    [1.00000,   0.00000,   0.23237],
    [1.00000,   0.00000,   0.26677],
    [1.00000,   0.00000,   0.30117],
    [1.00000,   0.00000,   0.33557],
    [1.00000,   0.00000,   0.36997],
    [1.00000,   0.00000,   0.40437],
    [1.00000,   0.00000,   0.43877],
    [1.00000,   0.00000,   0.47317],
    [1.00000,   0.00000,   0.50757],
    [1.00000,   0.00000,   0.54197],
    [1.00000,   0.00000,   0.57637],
    [1.00000,   0.00000,   0.61077],
    [1.00000,   0.00000,   0.64517],
    [1.00000,   0.00000,   0.67957],
    [1.00000,   0.00000,   0.71397],
    [1.00000,   0.00000,   0.74837],
    [1.00000,   0.00000,   0.78277],
    [1.00000,   0.00000,   0.81717],
    [1.00000,   0.00000,   0.85157],
    [1.00000,   0.00000,   0.88596],
    [1.00000,   0.00000,   0.92036],
    [1.00000,   0.00000,   0.95476],
    [1.00000,   0.00000,   0.98916],
    [0.98456,   0.01544,   0.98456],
    [0.96202,   0.03798,   0.96202],
    [0.93949,   0.06051,   0.93949],
    [0.91695,   0.08305,   0.91695],
    [0.89441,   0.10559,   0.89441],
    [0.87187,   0.12813,   0.87187],
    [0.84934,   0.15066,   0.84934],
    [0.82680,   0.17320,   0.82680],
    [0.80426,   0.19574,   0.80426],
    [0.78172,   0.21828,   0.78172],
    [0.75918,   0.24082,   0.75918],
    [0.73665,   0.26335,   0.73665],
    [0.71411,   0.28589,   0.71411],
    [0.69157,   0.30843,   0.69157],
    [0.66903,   0.33097,   0.66903],
    [0.64650,   0.35350,   0.64650],
    [0.62396,   0.37604,   0.62396],
    [0.60142,   0.39858,   0.60142],
    [0.57888,   0.42112,   0.57888],
    [0.55634,   0.44366,   0.55634],
    [0.53381,   0.46619,   0.53381],
    [0.51127,   0.48873,   0.51127],
    [0.48873,   0.51127,   0.48873],
    [0.46619,   0.53381,   0.46619],
    [0.44366,   0.55634,   0.44366],
    [0.42112,   0.57888,   0.42112],
    [0.39858,   0.60142,   0.39858],
    [0.37604,   0.62396,   0.37604],
    [0.35350,   0.64650,   0.35350],
    [0.33097,   0.66903,   0.33097],
    [0.30843,   0.69157,   0.30843],
    [0.28589,   0.71411,   0.28589],
    [0.26335,   0.73665,   0.26335],
    [0.24082,   0.75918,   0.24082],
    [0.21828,   0.78172,   0.21828],
    [0.19574,   0.80426,   0.19574],
    [0.17320,   0.82680,   0.17320],
    [0.15066,   0.84934,   0.15066],
    [0.12813,   0.87187,   0.12813],
    [0.10559,   0.89441,   0.10559],
    [0.08305,   0.91695,   0.08305],
    [0.06051,   0.93949,   0.06051],
    [0.03798,   0.96202,   0.03798],
    [0.01544,   0.98456,   0.01544],
    [0.00000,   1.00000,   0.01084],
    [0.00000,   1.00000,   0.04524],
    [0.00000,   1.00000,   0.07964],
    [0.00000,   1.00000,   0.11404],
    [0.00000,   1.00000,   0.14843],
    [0.00000,   1.00000,   0.18283],
    [0.00000,   1.00000,   0.21723],
    [0.00000,   1.00000,   0.25163],
    [0.00000,   1.00000,   0.28603],
    [0.00000,   1.00000,   0.32043],
    [0.00000,   1.00000,   0.35483],
    [0.00000,   1.00000,   0.38923],
    [0.00000,   1.00000,   0.42363],
    [0.00000,   1.00000,   0.45803],
    [0.00000,   1.00000,   0.49243],
    [0.00000,   1.00000,   0.52683],
    [0.00000,   1.00000,   0.56123],
    [0.00000,   1.00000,   0.59563],
    [0.00000,   1.00000,   0.63003],
    [0.00000,   1.00000,   0.66443],
    [0.00000,   1.00000,   0.69883],
    [0.00000,   1.00000,   0.73323],
    [0.00000,   1.00000,   0.76763],
    [0.00000,   1.00000,   0.80203],
    [0.00000,   1.00000,   0.83643],
    [0.00000,   1.00000,   0.87083],
    [0.00000,   1.00000,   0.90523],
    [0.00000,   1.00000,   0.93963],
    [0.00000,   1.00000,   0.97403],
    [0.00519,   1.00000,   0.99481],
    [0.02639,   1.00000,   0.97361],
    [0.04759,   1.00000,   0.95241],
    [0.06879,   1.00000,   0.93121],
    [0.08998,   1.00000,   0.91002],
    [0.11118,   1.00000,   0.88882],
    [0.13238,   1.00000,   0.86762],
    [0.15358,   1.00000,   0.84642],
    [0.17477,   1.00000,   0.82523],
    [0.19597,   1.00000,   0.80403],
    [0.21717,   1.00000,   0.78283],
    [0.23837,   1.00000,   0.76163],
    [0.25957,   1.00000,   0.74043],
    [0.28076,   1.00000,   0.71924],
    [0.30196,   1.00000,   0.69804],
    [0.32316,   1.00000,   0.67684],
    [0.34436,   1.00000,   0.65564],
    [0.36555,   1.00000,   0.63445],
    [0.38675,   1.00000,   0.61325],
    [0.40795,   1.00000,   0.59205],
    [0.42915,   1.00000,   0.57085],
    [0.45034,   1.00000,   0.54966],
    [0.47154,   1.00000,   0.52846],
    [0.49274,   1.00000,   0.50726],
    [0.51394,   1.00000,   0.48606],
    [0.53514,   1.00000,   0.46486],
    [0.55633,   1.00000,   0.44367],
    [0.57753,   1.00000,   0.42247],
    [0.59873,   1.00000,   0.40127],
    [0.61993,   1.00000,   0.38007],
    [0.64112,   1.00000,   0.35888],
    [0.66232,   1.00000,   0.33768],
    [0.68352,   1.00000,   0.31648],
    [0.70472,   1.00000,   0.29528],
    [0.72591,   1.00000,   0.27409],
    [0.74711,   1.00000,   0.25289],
    [0.76831,   1.00000,   0.23169],
    [0.78951,   1.00000,   0.21049],
    [0.81070,   1.00000,   0.18930],
    [0.83190,   1.00000,   0.16810],
    [0.85310,   1.00000,   0.14690],
    [0.87430,   1.00000,   0.12570],
    [0.89550,   1.00000,   0.10450],
    [0.91669,   1.00000,   0.08331],
    [0.93789,   1.00000,   0.06211],
    [0.95909,   1.00000,   0.04091],
    [0.98029,   1.00000,   0.01971],
    [1.00000,   1.00000,   0.00241],
    [1.00000,   1.00000,   0.03681],
    [1.00000,   1.00000,   0.07121],
    [1.00000,   1.00000,   0.10561],
    [1.00000,   1.00000,   0.14001],
    [1.00000,   1.00000,   0.17441],
    [1.00000,   1.00000,   0.20881],
    [1.00000,   1.00000,   0.24321],
    [1.00000,   1.00000,   0.27761],
    [1.00000,   1.00000,   0.31201],
    [1.00000,   1.00000,   0.34641],
    [1.00000,   1.00000,   0.38080],
    [1.00000,   1.00000,   0.41520],
    [1.00000,   1.00000,   0.44960],
    [1.00000,   1.00000,   0.48400],
    [1.00000,   1.00000,   0.51840],
    [1.00000,   1.00000,   0.55280],
    [1.00000,   1.00000,   0.58720],
    [1.00000,   1.00000,   0.62160],
    [1.00000,   1.00000,   0.65600],
    [1.00000,   1.00000,   0.69040],
    [1.00000,   1.00000,   0.72480],
    [1.00000,   1.00000,   0.75920],
    [1.00000,   1.00000,   0.79360],
    [1.00000,   1.00000,   0.82800],
    [1.00000,   1.00000,   0.86240],
    [1.00000,   1.00000,   0.89680],
    [1.00000,   1.00000,   0.93120],
    [1.00000,   1.00000,   0.96560],
    [1.00000,   1.00000,   1.00000]])

    D = np.round(I*255, decimals=0)
    kdt = KDTree(D)
    dists = np.array([[None] * width] * height)
    inds = np.array([[None] * width] * height)
    
# K-D Tree

    for y in range(height):
        for x in range(width):
            dist, ind = kdt.query([img_pixels[x,y]], k=1)
            # dists[x,y] = dist[0][0]
            inds[y,x] = ind[0][0]

                
    pp = pprint.PrettyPrinter(indent=4)
    # pp.pprint(inds)
    arr = np.array(inds)
    disp_img = Image.fromarray(arr.astype('uint8'))
    disp_img.show()
    
if __name__ == "__main__":
    main()